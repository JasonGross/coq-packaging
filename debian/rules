#!/usr/bin/make -f
# debian/rules for coq

# Uncomment this to turn on verbose mode.
#export DH_VERBOSE=1

# This has to be exported to make some magic below work.
export COQTEST_SKIPCOMPLEXITY = true
export CAML_LD_LIBRARY_PATH = $(shell pwd)/kernel/byterun

# We want to use dpatch
include /usr/share/dpatch/dpatch.make

HTMLDOC := doc/stdlib/html/index.html

COQPREF := $(CURDIR)/debian/tmp
ADDPREF := COQINSTALLPREFIX=$(COQPREF)

OFILES := $(patsubst %.in,%,$(wildcard debian/*.in))
OCAMLABI := $(shell ocamlc -version)

CONFIGUREOPTS := --arch Linux --prefix /usr --mandir /usr/share/man \
  --emacslib /usr/share/emacs/site-lisp/coq --reals all --fsets all \
  --browser "/usr/bin/x-www-browser %s &" \
  --with-doc no --coqrunbyteflags "-dllib -lcoqrun"

OCAMLINITSED := -e 's/@OCamlABI@/$(OCAMLABI)/g'

ifeq ($(shell test -e /usr/bin/ocamlopt && echo yes),yes)
  CONFIGUREOPTS += -opt
  OCAMLINITSED += -e 's/^OPT: //'
else
  OCAMLINITSED += -e '/^OPT: /d'
endif

ocamlinit: ocamlinit-stamp
ocamlinit-stamp:
	for f in $(OFILES); do sed $(OCAMLINITSED) $$f.in > $$f; done
	touch $@

configure: configure-stamp
configure-stamp: patch-stamp ocamlinit-stamp
	dh build --before dh_auto_configure
	./configure $(CONFIGUREOPTS)
	echo 'F:OCamlABI="$(OCAMLABI)"' > debian/substvars
	touch $@

build: build-stamp
build-stamp: configure-stamp
	dh_testdir
	$(MAKE) STRIP=true check
	if [ -f bin/coqtop.opt ]; then touch opt-stamp; fi
	$(MAKE) COQDOC="bin/coqdoc --coqlib_path `pwd`" \
	  DOC_TARGETS=$(HTMLDOC) $(HTMLDOC)
	dh build --after dh_auto_test
	touch $@

install: install-stamp
install-stamp: build-stamp
	dh install --before dh_auto_install
	$(MAKE) $(ADDPREF) install
	dh_install -XFAQ --list-missing
	mv debian/coq-libs/usr/lib/coq/contrib/micromega/csdpcert debian/coq/usr/lib/coq/contrib/micromega
	cp debian/coq.xpm debian/coq/usr/share/pixmaps
	cp debian/coq.xpm debian/coqide/usr/share/pixmaps/coqide.xpm
	cp debian/coqide.desktop debian/coqide/usr/share/applications
	cp -r doc/stdlib/html debian/coq-libs/usr/share/doc/coq-libs/
	dh install --after dh_install
	touch $@

clean: unpatch
	dh $@
	rm -f debian/substvars $(OFILES)

binary-indep: install-stamp
	dh $@

binary-arch: install-stamp
	dh $@

binary: binary-indep binary-arch
.PHONY: build clean binary-indep binary-arch binary install configure ocamlinit
